<!DOCTYPE html>

<html>
<head>
  <title>parser.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
<div id="container">
  <table cellspacing="0" cellpadding="0">
    <thead>
    <tr>
      <th class="docs">
        
        <h1><a href="../index.html" title="Back to index">&larr;</a>&nbsp;&nbsp;parser.js</h1>
        
      </th>
      <th class="code"></th>
    </tr>
    </thead>
    <tbody>
    
    
    <tr id="section-1">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
      <h2 id="parsing">Parsing</h2>

<p>This will find nearest comment begining</p>
      </td>
      <td class="code">
      <pre><code class="javascript">
<span class="keyword">var</span> nextCommentBegin = <span class="keyword">function</span>(comments, data, fromPos) {
	<span class="keyword">return</span> nextCommentPart(comments, data, <span class="number">0</span>, fromPos)
}

</code></pre>
      </td>
    </tr>
    
    
    <tr id="section-2">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
      <pre><code class="javascript"><span class="keyword">var</span> a = <span class="string">'test'</span>;
<span class="comment">//comments in text</span>
<span class="comment">//but it is valid code</span>
<span class="comment">//&lt;pre&gt;&lt;code&gt;&lt;/code&gt;&lt;/pre&gt;</span>
</code></pre>
      </td>
      <td class="code">
      <pre><code class="javascript">
<span class="keyword">var</span> nextCommentEnd = <span class="keyword">function</span>(comments, data, fromPos) {
	<span class="keyword">return</span> nextCommentPart(comments, data, <span class="number">1</span>, fromPos)
}

<span class="keyword">var</span> nextCommentPart = <span class="keyword">function</span>(comments, data, part, fromPos) {
	fromPos = fromPos || <span class="number">0</span>

	<span class="keyword">return</span> comments.map(<span class="keyword">function</span>(comment, index) {
			<span class="keyword">return</span> { 
				comment: index, 
				textPos: data.indexOf(comment[part], fromPos) 
			}
		}).reduce(<span class="keyword">function</span>(prevComment, currentComment) {
			<span class="keyword">return</span> prevComment.textPos &gt; currentComment.textPos &amp;&amp; currentComment.textPos != -<span class="number">1</span> ? currentComment : prevComment
		}, { 
			comment: -<span class="number">1</span>, 
			textPos: data.length
		})
}

<span class="keyword">var</span> parseString = <span class="keyword">function</span>(comments, data) {
	<span class="keyword">var</span> result = []

	<span class="keyword">var</span> commentBeginFrom = <span class="number">0</span>

	<span class="keyword">var</span> nextBegin = nextCommentBegin(comments, data, commentBeginFrom)

	<span class="keyword">var</span> prevComment = <span class="string">""</span>

	<span class="keyword">var</span> tryCombineLastBlocks = <span class="keyword">function</span>(block) {
		<span class="keyword">if</span>(result.length &gt;<span class="number">0</span> ) {
			<span class="keyword">var</span> lastAddedBlock = result[result.length - <span class="number">1</span>]
			<span class="keyword">if</span>(lastAddedBlock.code.trim() === <span class="string">""</span>) {
				<span class="comment">//seems we can combine blocks</span>
				lastAddedBlock.comment += <span class="string">"\n"</span> + block.comment
				lastAddedBlock.code = block.code
				<span class="keyword">return</span> <span class="literal">true</span>
			} <span class="keyword">else</span> <span class="keyword">if</span>(lastAddedBlock.comment.trim() === <span class="string">""</span>){
				lastAddedBlock.code += <span class="string">"\n"</span> + block.code
				lastAddedBlock.comment = block.comment
				<span class="keyword">return</span> <span class="literal">true</span>
			}
		}
		<span class="keyword">return</span> <span class="literal">false</span>
	}

	<span class="keyword">var</span> tryAddBlock = <span class="keyword">function</span>() {
		<span class="keyword">var</span> code = data.substring(commentBeginFrom, nextBegin.textPos)

		<span class="keyword">if</span>(code.trim() !== <span class="string">""</span> || prevComment.trim() !== <span class="string">""</span>) {
			<span class="keyword">var</span> block = { 
				code: code, 
				comment: prevComment
			}

			<span class="keyword">if</span>(!tryCombineLastBlocks(block)) {
				result.push(block)
			}
		}
	}

	<span class="keyword">while</span>(nextBegin.comment !== -<span class="number">1</span>) {
		<span class="keyword">var</span> comment = comments[nextBegin.comment]

		tryAddBlock()

		<span class="keyword">var</span> nextEnd = nextCommentEnd([comment], data, nextBegin.textPos + comment[<span class="number">0</span>].length)

		prevComment = data.substring(nextBegin.textPos + comment[<span class="number">0</span>].length, nextEnd.textPos)

		commentBeginFrom = nextEnd.textPos + comment[<span class="number">1</span>].length

		nextBegin = nextCommentBegin(comments, data, commentBeginFrom)
	}

	tryAddBlock()

	<span class="keyword">return</span> result
}

module.exports.parseString = parseString 

module.exports.nextCommentPart = nextCommentPart 
</code></pre>
      </td>
    </tr>
    
  </table>
</div>
</body>
</html>



